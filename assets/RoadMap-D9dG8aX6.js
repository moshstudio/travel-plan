import{d as bt,ae as Mt,r as M,f as K,B as tt,K as Pt,L as kt,ag as E,a as S,ai as i,aj as N,am as Dt,aw as Et,ad as St,ak as P,an as It,ao as Lt,aQ as R,a$ as Bt,ah as k,Z as Rt,aq as Ft}from"./index-d8_m604x.js";import{a as Tt,_ as et,N as Vt,I as zt}from"./index-C3vBwbN3.js";import{d as Yt,e as Zt,g as Nt,m as Xt,h as Qt,i as $t,j as Ht,k as Gt,l as Ot,n as jt,M as qt,V as st,f as I,T as ot,X as at,S as nt,c as Ut,I as Wt,P as Jt,a as Kt,o as te}from"./XYZ-lN7jL1I7.js";import{l as ee,i as se,b as oe,V as ae,a as ne,F as re}from"./Vector-hE7sZCpc.js";import{t as ie,a as le}from"./tdt-CGZYR8xf.js";import{s as ce}from"./index-mAKpSMLY.js";import{f as de}from"./format-BUPkFkKG.js";class F extends Yt{constructor(a,l){super(),this.flatMidpoint_=null,this.flatMidpointRevision_=-1,this.maxDelta_=-1,this.maxDeltaRevision_=-1,l!==void 0&&!Array.isArray(a[0])?this.setFlatCoordinates(l,a):this.setCoordinates(a,l)}appendCoordinate(a){Zt(this.flatCoordinates,a),this.changed()}clone(){const a=new F(this.flatCoordinates.slice(),this.layout);return a.applyProperties(this),a}closestPointXY(a,l,w,y){return y<Nt(this.getExtent(),a,l)?y:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(Xt(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),Qt(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,this.maxDelta_,!1,a,l,w,y))}forEachSegment(a){return $t(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,a)}getCoordinateAtM(a,l){return this.layout!="XYM"&&this.layout!="XYZM"?null:(l=l!==void 0?l:!1,ee(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,a,l))}getCoordinates(){return Ht(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getCoordinateAt(a,l){return se(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,a,l,this.stride)}getLength(){return oe(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)}getFlatMidpoint(){return this.flatMidpointRevision_!=this.getRevision()&&(this.flatMidpoint_=this.getCoordinateAt(.5,this.flatMidpoint_??void 0),this.flatMidpointRevision_=this.getRevision()),this.flatMidpoint_}getSimplifiedGeometryInternal(a){const l=[];return l.length=Gt(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,a,l,0),new F(l,"XY")}getType(){return"LineString"}intersectsExtent(a){return Ot(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,a,this.getExtent())}setCoordinates(a,l){this.setLayout(l,a,1),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=jt(this.flatCoordinates,0,a,this.stride),this.changed()}}const ue="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAWNJREFUWEftlC1LBUEUhp8XbGYFwWA0iGARbN5oMBpFbrgqIiIWQUQQgyAYREQR8SNY9Ed4EcFgMirob1Ax2I53YMKy7t7ZXcOWOWVgz5nzPvuemRE1h2rWJwJEB6ID0YGgA2bWB8wAb8CjpK8ij5eZDQITQK+ky7w9XQHMbAS4BYZ9gxdgXtJ9NwgzawLniZonSeNZe0IAC8BJauMn0JLkwP6Ema0B+xmphqR2+nsI4AhYyvnbFUmHyZyZ7QCbOfXNrFGEAAaAZ8Cdg6zYlbThEmbmYJZz6tqSGqVH4BtPAVddIC6Ans4hnc0RfwDmJL1XAvAQo4A7yWNFbkCi5saL/1S6Ban59gNnwHRBiANJq6Ha4DuQbmBmx8BioPG6pL2QuMuXBvAj2ers3c4Q+HZwkq6LiFcG8BAt4DQh9OrF74qK/wvAQwwBk8BHZ3VXza2lotIISikEiiNAdCA6EB2o3YFfuiddIfGgL+MAAAAASUVORK5CYII=",he={class:"relative w-screen h-screen flex flex-col"},ge={class:"absolute z-10 top-12 left-0 right-0 flex justify-center pointer-events-none"},fe={class:"bg-white bg-opacity-90 px-3 py-2 rounded-b-lg shadow-md flex items-center"},ve={class:"text-sm text-gray-700"},me={key:0,class:"absolute z-20 top-1/2 left-0 right-0 mx-4 transform -translate-y-1/2"},pe={class:"bg-white bg-opacity-90 rounded-lg shadow-lg p-3"},ye={class:"flex justify-between items-center mb-2"},we={class:"text-xs space-y-1"},Ce={class:"flex"},Ae={class:"flex"},xe={class:"flex"},_e={class:"flex"},be={key:1,class:"absolute z-10 bottom-4 left-0 right-0 flex justify-center transition-all duration-300 pointer-events-none"},Me={class:"grid grid-cols-3 max-w-[90vw] gap-[8px] bg-white bg-opacity-90 px-3 py-2 rounded-lg shadow-md"},Pe={class:"text-xs"},ke=bt({__name:"RoadMap",setup(De){const a=Tt(),{travelPlansFromToday:l}=Mt(a),w=M(!0),y=M(!1),T=M(!0),m=M(null),rt=K(()=>{if(u.value.length===0)return"暂无行程计划";const e=new Date(u.value[0].startDateTime),t=new Date(u.value[u.value.length-1].endDateTime);return`行程: ${e.getMonth()+1}月${e.getDate()}日 - ${t.getMonth()+1}月${t.getDate()}日 | ${u.value.length}个地点`}),it=K(()=>[{color:"oklch(70.7% 0.022 261.325)",label:"未开始"},{color:"oklch(85.2% 0.199 91.936)",label:"即将开始"},{color:"oklch(79.2% 0.209 151.711)",label:"进行中"},{color:"oklch(70.4% 0.191 22.216)",label:"已结束"},{color:"oklch(70.7% 0.165 254.624)",label:"已完成"},{color:"oklch(70.7% 0.022 261.325)",label:"已取消"}]),u=M([]),lt=()=>{l.value||(u.value=[]),u.value=et.cloneDeep(l.value).sort((e,t)=>e.startDateTime-t.startDateTime)},ct=e=>{const t=new Date(e),r=t.getDate(),c=t.getMonth(),g=t.getFullYear(),s=r+c*31+g*365,n=s*137.5%360,d=40+s%20,h=65+s%10;return`hsl(${n}, ${d}%, ${h}%)`},dt=e=>{switch(e){case"high":return"#f87171";case"medium":return"#fbbf24";case"low":return"#4ade80";default:return"#94a3b8"}},ut=e=>{switch(e){case"planned":return"oklch(70.7% 0.022 261.325)";case"upcoming":return"oklch(85.2% 0.199 91.936)";case"in-progress":return"oklch(79.2% 0.209 151.711)";case"expired":return"oklch(70.4% 0.191 22.216)";case"cancelled":return"oklch(70.7% 0.022 261.325)";case"completed":return"oklch(70.7% 0.165 254.624)";default:return"#94a3b8"}},A=(e,t="MM/dd HH:mm")=>{const r=new Date(e);return r.getMinutes()===0&&(r.getHours()===0?t=t.replace(" HH:mm","日").replace("/","月"):t=t.replace(":mm","点")),de(new Date(e),t)},X=(e,t)=>{var r;return(r=u.value.find(c=>c.location.coordinates.lng===e&&c.location.coordinates.lat===t))==null?void 0:r.location.name},Q=(e,t)=>{const[r,c]=e,[g,s]=t,n=6371,d=(s-c)*Math.PI/180,h=(g-r)*Math.PI/180,p=Math.sin(d/2)*Math.sin(d/2)+Math.cos(c*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(h/2)*Math.sin(h/2),v=2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p));return(n*v).toFixed(1)},V=M(null);let o=null,C=null;const x=[],f=[],ht=async()=>{if(V.value){T.value=!0;try{o=new qt({target:V.value,layers:[new ot({source:new at({url:await ie(),maxZoom:17})}),new ot({source:new at({url:await le(),maxZoom:17})})],view:new st({center:I([116.404,39.915]),zoom:12})}),C=new ae({source:new ne}),o.addLayer(C),z()}catch(e){console.error("地图初始化失败:",e)}finally{T.value=!1}}},gt=e=>{const t=dt(e.priority),r=R("div",{class:"flex flex-col items-center justify-start text-sm p-0",style:{color:"black"}},[R("div",{class:"font-bold text-xs flex w-full",style:{color:t}},e.title),R("div",{class:"text-xs",style:{color:"grey"}},A(e.startDateTime)),R("div",{class:"text-xs",style:{color:"grey"}},A(e.endDateTime))]),c=document.createElement("div");return Bt(r,c),c.innerHTML},z=async()=>{var g;if(!o||!C)return;const e=C.getSource();if(!e||(f.forEach(s=>{o==null||o.removeOverlay(s)}),f.length=0,x.forEach(s=>{o==null||o.removeOverlay(s)}),x.length=0,e.clear(),u.value.length===0))return;const t=[];u.value.forEach(s=>{const n=[s.location.coordinates.lng,s.location.coordinates.lat];t.push(n)});const r=[];for(let s=0;s<t.length-1;s++){const n=t[s],d=t[s+1],h=[I(n),I(d)],p=new F(h),v=new re({geometry:p,startIndex:s,endIndex:s+1,startCoord:n,endCoord:d}),L=u.value[s],Y=ct(L.startDateTime);v.setStyle((H,yt)=>{var B=v.getGeometry();if(!B)return;var wt=B.getLength(),Ct=50*yt/wt,G=1,O=[new nt({stroke:new Ut({color:`${Y}`,width:6})})];const j=(o==null?void 0:o.getView().getZoom())||10;for(var Z=0;Z<=1;Z+=Ct){var D=B.getCoordinateAt(Z);B.forEachSegment(function(_,b){if(!(_[0]==b[0]||_[1]==b[1])){var q=b[0]-D[0],U=b[1]-D[1],W=D[0]-_[0],J=D[1]-_[1];if(q!=W&&U!=J&&Math.abs(G*q*J-G*W*U)<.005/(j<10?1:(j-10)*20+10)){var At=b[0]-_[0],xt=b[1]-_[1],_t=Math.atan2(xt,At);O.push(new nt({geometry:new Jt(D),image:new Wt({src:ue,anchor:[.5,.5],rotateWithView:!1,rotation:-_t-Math.PI/2,opacity:.8,scale:.3})}))}}})}return O}),r.push(v)}e.addFeatures(r),u.value.forEach((s,n)=>{var p,v;const d=t[n],h=new Kt({color:ut(s.status)});o==null||o.addOverlay(h),x.push(h),h.setClassName("my-placemark z-[10]"),(p=h.getElement())==null||p.classList.add("scale-[0.8]"),h.setPosition(I(d)),h.show(I(d),`<div class="flex items-center justify-center text-black">${n+1}</div>`),(v=h.getElement())==null||v.addEventListener("click",()=>{f[n]&&(f[n].getPosition()?(f[n].setPosition(void 0),f[n].hide()):f[n].setPosition(x[n].getPosition()))})}),u.value.forEach((s,n)=>{const d=new te({popupClass:"default",closeBox:!1,onclose:()=>{o==null||o.getTargetElement().focus()},autoPan:{animation:{duration:100}}});o==null||o.addOverlay(d),f.push(d),d.setPopupClass("my-popup z-[20] bg-white/70 shadow-lg p-1"),d.setPositioning("top-left"),d.show(x[n].getPosition(),gt(s))});const c=(g=C.getSource())==null?void 0:g.getExtent();c&&(o==null||o.getView().fit(c,{duration:1e3,padding:[50,50,50,50]}))},ft=async e=>{if(!o||!C)return;const t=o.getEventPixel(e),r=o.getFeaturesAtPixel(t,{layerFilter:c=>c===C,hitTolerance:10});if(r.length>0){const c=r[0],{startIndex:g,endIndex:s,startCoord:n,endCoord:d}=c.getProperties();try{const[h,p]=await Promise.all([X(n[0],n[1]),X(d[0],d[1])]),v=Q(n,d),L=u.value[g],Y=u.value[s],H=`${A(L.startDateTime)} - ${A(Y.endDateTime)}`;m.value={startAddress:h||"未知地址",endAddress:p||"未知地址",distance:v,time:H}}catch(h){console.error("获取路线详情失败:",h),m.value={startAddress:"未知地址",endAddress:"未知地址",distance:Q(n,d),time:`${A(u.value[g].startDateTime)} - ${A(u.value[s].endDateTime)}`}}}else m.value=null},vt=()=>{w.value=!w.value},mt=()=>{y.value=!y.value,console.log(!y.value)},pt=()=>{if(o)if(!w.value)f.forEach(e=>{e.hide()});else{const e=o.getView(),t={center:e.getCenter(),zoom:e.getZoom(),projection:"EPSG:3857"};f.forEach((r,c)=>{r.setPosition(x[c].getPosition())}),o.setView(new st(t))}},$=()=>{lt()};return tt(u,et.debounce(z,300),{deep:!0}),tt(w,()=>{pt()}),Pt(async()=>{await ce(500),await ht(),$()}),kt(()=>{z()}),(e,t)=>{const r=zt,c=Vt,g=St;return k(),E("div",he,[S(c,{title:"路线图","left-arrow":"",onClickLeft:t[0]||(t[0]=s=>e.$router.back())},{right:Dt(()=>[S(r,{name:w.value?"eye-o":"closed-eye",size:"18",onClick:vt,class:"mr-2"},null,8,["name"]),S(r,{name:"replay",size:"18",onClick:$,class:"mr-2"})]),_:1}),i("div",ge,[i("div",fe,[T.value?(k(),Et(g,{key:0,type:"spinner",size:"20px",class:"mr-2"})):N("",!0),i("span",ve,P(rt.value),1)])]),i("div",{ref_key:"mapContainer",ref:V,class:"travel-map w-full h-full",onClick:ft},null,512),m.value?(k(),E("div",me,[i("div",pe,[i("div",ye,[t[2]||(t[2]=i("h3",{class:"text-sm font-bold"},"路线详情",-1)),S(r,{name:"cross",size:"14",onClick:t[1]||(t[1]=s=>m.value=null)})]),i("div",we,[i("div",Ce,[t[3]||(t[3]=i("span",{class:"text-gray-500 w-16"},"起点:",-1)),i("span",null,P(m.value.startAddress||"未知地址"),1)]),i("div",Ae,[t[4]||(t[4]=i("span",{class:"text-gray-500 w-16"},"终点:",-1)),i("span",null,P(m.value.endAddress||"未知地址"),1)]),i("div",xe,[t[5]||(t[5]=i("span",{class:"text-gray-500 w-16"},"距离:",-1)),i("span",null,P(m.value.distance)+"公里",1)]),i("div",_e,[t[6]||(t[6]=i("span",{class:"text-gray-500 w-16"},"时间:",-1)),i("span",null,P(m.value.time),1)])])])])):N("",!0),S(r,{name:"info",size:"18",onClick:mt,class:"absolute left-2 bottom-10"}),y.value?(k(),E("div",be,[i("div",Me,[(k(!0),E(It,null,Lt(it.value,(s,n)=>(k(),E("div",{class:"flex items-center mb-1",key:n},[i("div",{class:"w-4 h-4 rounded-full mr-2",style:Rt({backgroundColor:s.color})},null,4),i("span",Pe,P(s.label),1)]))),128))])])):N("",!0)])}}}),Te=Ft(ke,[["__scopeId","data-v-0db3e04c"]]);export{Te as default};
